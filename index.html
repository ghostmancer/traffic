<!DOCTYPE html>
<html style="margin: 0; width: 100%; height: 100%;">
    <head>
        <script type="text/javascript" src="paper-full.min.js"></script>
        <script type="text/paperscript" canvas="myCanvas">
            var width = view.size.width;
            var height = view.size.height;

            var roads = [];
            var intersections = [];

            var directions = ['N', 'E', 'S', 'W'];

            for(var i = 0; i < 20; i++) {
                var newIntersection = {};
                newIntersection.id = uuid();
                newIntersection.position = new Point(random(-2 * width, 2 * width), random(-2 * height, 2 * height));
                newIntersection.roads = new Array();
                intersections.push(newIntersection);
            }

            for(var i = 0; i < intersections.length; i++) {
                var intersection = intersections[i];
                var nearestArray = getNearestIntersections(intersection);
                for(var j = 0; j < 4; j++) {
                    var nearest = nearestArray[j];
                    var road = {
                        id: uuid(),
                        intersections: [
                            intersection,
                            nearest
                        ],
                        lanes: 1
                    }
                    addRoadToIntersection(intersection, nearest, road);
                }
                renderRoads();
            }

            function renderRoads() {
                for(var i = 0; i < roads.length; i++) {
                    var road = roads[i];
                    var path = new Path.Line(road.intersections[0].position, road.intersections[1].position);
                    path.strokeColor = 'black';
                }
            }

            function addRoadToIntersection(intersectionA, intersectionB, road) {
                function checkIfRoadExists(intersection, road) {
                    for(var i = 0; i < intersection.roads.length; i++) {
                        if(intersection.roads[i].id == road.id) {
                            return true;
                        }
                    }
                    return false;
                }

                if(checkIfRoadExists(intersectionA, road) || checkIfRoadExists(intersectionB, road)) {
                    return;
                }

                roads.push(road);
                intersectionA.roads.push(road);
                intersectionB.roads.push(road);
            }

            function getIntersectionById(id) {
                for(var i = 0; i < intersections.length; i++) {
                    if(intersections[i].id == id) {
                        return intersections[i];
                    }
                }
            }

            function getNearestIntersections(intersection) {
                var distances = [];
                var sortedArray = [];

                for(var i = 0; i < intersections.length; i++) {
                    if(intersections[i].id != intersection.id) {
                        distances.push({
                            id: intersections[i].id,
                            distance: intersection.position.getDistance(intersections[i].position)
                        });
                    }
                }

                distances.sort(function(a, b) {
                    return a.distance - b.distance;
                });

                for(var i = 0; i < distances.length; i++) {
                    sortedArray.push(getIntersectionById(distances[i].id));
                }

                return sortedArray;
            }

            function onKeyDown(event) {
                var transformDistance = 50;
                if(event.key == 'up') {
                    view.zoom = view.zoom + 0.1;
                }
            	if(event.key == 'down') {
                    view.zoom = view.zoom - 0.1;
                }
                if(event.key == 'w') {
                    var newCoordinates = {
                        x: project.activeLayer.getPosition()['_x'],
                        y: project.activeLayer.getPosition()['_y'] + transformDistance
                    }
                    project.activeLayer.setPosition(newCoordinates.x, newCoordinates.y);
                }
                if(event.key == 's') {
                    var newCoordinates = {
                        x: project.activeLayer.getPosition()['_x'],
                        y: project.activeLayer.getPosition()['_y'] - transformDistance
                    }
                    project.activeLayer.setPosition(newCoordinates.x, newCoordinates.y);
                }
                if(event.key == 'a') {
                    var newCoordinates = {
                        x: project.activeLayer.getPosition()['_x'] + transformDistance,
                        y: project.activeLayer.getPosition()['_y']
                    }
                    project.activeLayer.setPosition(newCoordinates.x, newCoordinates.y);
                }
                if(event.key == 'd') {
                    var newCoordinates = {
                        x: project.activeLayer.getPosition()['_x'] - transformDistance,
                        y: project.activeLayer.getPosition()['_y']
                    }
                    project.activeLayer.setPosition(newCoordinates.x, newCoordinates.y);
                }
            }

            console.log(intersections);
            function random(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }

            function uuid() {
                var S4 = function() {
                   return (((1+Math.random())*0x10000)|0).toString(16).substring(1);
                };
                return (S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4());
            }
        </script>
    </head>
    <body style="margin: 0; width: 100%; height: 100%;">
        <canvas id="myCanvas" resize="true" style="width: 100%; height: 100%;"></canvas>
    </body>
</html>
